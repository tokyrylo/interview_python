# Що таке винятки 

**Винятки (exceptions)** - це об'єкти, які сигналізують про помилки або інщі "виняткові" ситуації під час виконання програм. Python використовує механізм ***виняткового контролю потоку (`try`/`except`)*** для обробки таких ситуацій.

## Структура обробки винятків

```python
try:
    # код, який може згенерувати виняток
except SomeException as e:
    # обробка винятку
else:
    # якщо виняток не виник
finally:
    # використовується завжди, навіть якщо був виняток
```
 - `try`: Блок, в якому може виникнути помилка.
 - `except`: Блоки, які обробляють конкретні винятки.
 - `else`: (необов'язкові) Використовуться, якщо в `try` не виник виняток.
 - `finally`: Виконується у будь-якому випадку, часто використовується для закриття файлів, з'єднань тощо.

## Як працює обробка винятків на рівні інтерпретатора?

1. **Пошук обробника**: Якщо у блоці `try` виникає помилка, Python зупиняє виконання блоку та починає шукати відповідний `except`.
2. **Розмотування стеку** (stack unwinding): інтерпритатор "відкочується" назад до стеку викликів, поки не знайде обробник.
3. **Якщо не знайдено обробника**: Виняток буде проброщено вище, аж до `__main__`, і якщо ніде не оброблено - буде завершено виконання програми з traceback.

## Що відбувається у пам'яті?

 - Коли виникає виняток, Python сворює об'єкт винятку (інстанс класу, що наслідується від `BaseException`) і записує у спеціальну змінну (а CPython - `sys.exc_info()`).
 - До цього об'єкту належать:
    - сам тип (`Exception`)
    - повідомлення
    - traceback (шлях по стеку до точки помилки)
 - Важливо: **traceback зберігає посилання на об'єкти, які були в кожному фреймі стеку**, що може призвести до **витіку пам'яті**, якщо зберігати виняток довго(особливо в логах або глобальних змінних).

## Підводні камні:
1. **Зловлювання всіх винятків**
```python
except Exception
```
Це добре лище в обмежених випадках (наприклад, у логуванні). Погана практика - ловити всі винятки і нічого не робити з ними.

2. **Ніколи не використовуйте `except:` без типу винятку!** Це також ловить `KeyboardInterrupt`, `SystemExit` - критичні винятки, які не варто обробляти без потреби.

3. **Traceback і витік пам'яті:** Якщо  зберігаєш об'єкт винятку (`e`) десь глобально, пам'ятай, що  в ньому є посилання на стек. Це може перешкоджати збирачеві сміття (GC) видалити фрейми.

4. **Не використовуй винятки замість логіки**: Наприклад:

```python
try:
    value = d["key"]
except ValueError:
    value = None
```
Краще так:
```python
value = d.get("key")
```
## Додаткові можливості
 - Створення власних винятків:
 ```python
 class MyCustomError(Exception):
    pass
 ```
 - **Логування винятків**: Можна використовувати `logging` разом із `traceback`:
 ```python
 import logging
 logging.exception("Щось пішло не так")
 ```